#!/bin/bash

# Script: git-safe-merge.sh
# Usage: git-safe-merge [target-branch]
# Description: Merges the current branch into the target branch only if the 
# working directory is clean and the merge has no conflicts.

# --- Configuration ---
TARGET_BRANCH="$1"
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# --- 1. Argument Check ---
if [ -z "$TARGET_BRANCH" ]; then
    echo "‚ùå Error: You must provide a target branch name as the first argument."
    echo "Usage: $0 <target-branch>"
    exit 1
fi

# --- 2. Sanity Check: Ensure Target Branch Exists ---
if ! git rev-parse --verify "$TARGET_BRANCH" >/dev/null 2>&1; then
    echo "‚ùå Error: Target branch '$TARGET_BRANCH' does not exist locally."
    exit 1
fi

# --- 3. Clean Working Directory Check ---
if ! git diff-index --quiet HEAD --; then
    echo "‚ùå Aborting: Unstaged or uncommitted changes detected in the working directory."
    echo "Please commit or stash your changes before merging."
    exit 1
fi

# --- 4. Switch to Target Branch and Pull Latest (Optional but Recommended) ---
echo "‚û°Ô∏è Switching to target branch: $TARGET_BRANCH"
if ! git checkout "$TARGET_BRANCH" >/dev/null 2>&1; then
    echo "‚ùå Error: Could not switch to branch '$TARGET_BRANCH'."
    exit 1
fi

# Optional: Ensure the target branch is up-to-date
git pull # Uncomment if you want to pull latest changes before merging

# --- 5. Attempt Merge (Using --no-commit --no-ff) ---
echo "üîÑ Attempting to merge '$CURRENT_BRANCH' into '$TARGET_BRANCH'..."

# The --no-commit flag prevents an automatic commit, allowing us to check for conflicts first.
# The --no-ff flag ensures a merge commit is created, even if it could be a fast-forward.
if git merge --no-commit --no-ff "$CURRENT_BRANCH"; then
    
    # --- 6. Conflict Check ---
    if [ $(git ls-files -u | wc -l) -gt 0 ]; then
        echo "‚ùå Aborting: Merge conflicts detected."
        # Clean up the failed merge state
        git merge --abort
        echo "The merge has been aborted. Please switch back to $CURRENT_BRANCH to resolve."
        exit 1
    else
        # --- 7. Finalize Merge ---
        echo "‚úÖ Merge successful! No conflicts found."
        
        # Commit the clean merge
        git commit -m "Merge branch '$CURRENT_BRANCH' into $TARGET_BRANCH"
        
        echo "üéâ Merge committed on branch $TARGET_BRANCH."
        
        # --- 8. Switch Back to Original Branch (Recommended) ---
        echo "üîô Switching back to original branch: $CURRENT_BRANCH"
        git checkout "$CURRENT_BRANCH" >/dev/null 2>&1
        exit 0
    fi
else
    # This handles cases where git merge fails for reasons other than conflicts (e.g., hooks)
    echo "‚ùå Error: Merge command failed unexpectedly."
    git merge --abort >/dev/null 2>&1 # Ensure cleanup
    exit 1
fi
